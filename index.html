<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>موقعي بالنقاط</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body style="font-family: sans-serif; direction: rtl; text-align: center;">

  <h1>رصيدك: <span id="points">0</span> نقطة</h1>
  <input type="text" id="telegramId" placeholder="أدخل Telegram ID">
  <button onclick="saveUser()">حفظ الحساب</button>
  <hr>

  <h2>📢 أخبار الموقع</h2>
  <p>مرحبا بك في موقع تجميع النقاط</p>
  <hr>

  <h2>🎯 المهمات</h2>
  <button onclick="earnPoints()">شاهد فيديو واربح 50 نقطة</button>

  <script>
    // ربط Supabase
    const SUPABASE_URL = "https://ulmawlwxrbtojwpviaju.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVsbWF3bHd4cmJ0b2p3cHZpYWp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTg4MDMsImV4cCI6MjA3MTY5NDgwM30.AfuqZawzxqNxJ3d7H8PTB7ywRb_YpWEvFQH9HHZvDJ8";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;

    async function saveUser() {
      const telegramId = document.getElementById("telegramId").value;
      if (!telegramId) {
        alert("أدخل Telegram ID");
        return;
      }

      // تحقق واش المستخدم موجود
      let { data: users } = await supabase
        .from("users")
        .select("*")
        .eq("telegram_id", telegramId)
        .single();

      if (!users) {
        // إذا ماكاينش، ندير إدخال جديد
        let { data, error } = await supabase
          .from("users")
          .insert([{ telegram_id: telegramId, points: 0 }]);

        if (error) {
          alert("خطأ: " + error.message);
          return;
        }
        currentUser = { telegram_id: telegramId, points: 0 };
      } else {
        currentUser = users;
      }

      document.getElementById("points").innerText = currentUser.points;
      alert("تم حفظ الحساب!");
    }

    async function earnPoints() {
      if (!currentUser) {
        alert("أدخل Telegram ID أولا!");
        return;
      }

      const newPoints = currentUser.points + 50;

      let { data, error } = await supabase
        .from("users")
        .update({ points: newPoints })
        .eq("telegram_id", currentUser.telegram_id);

      if (error) {
        alert("خطأ: " + error.message);
        return;
      }

      currentUser.points = newPoints;
      document.getElementById("points").innerText = currentUser.points;
      alert("ربحت 50 نقطة!");
    }
  </script>
</body>
</html>
