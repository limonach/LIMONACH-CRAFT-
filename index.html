<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ูููุนู ุจุงูููุงุท</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    #earnBtn[disabled] {
      background-color: #ccc;
      cursor: not-allowed;
    }
    #adContainer {
      display: none;
      margin-top: 20px;
    }
  </style>
</head>
<body style="font-family: sans-serif; direction: rtl; text-align: center;">

  <h1>ุฑุตูุฏู: <span id="points">0</span> ููุทุฉ</h1>
  <hr>

  <h2>๐ข ุฃุฎุจุงุฑ ุงููููุน</h2>
  <p>ูุฑุญุจุง ุจู ูู ูููุน ุชุฌููุน ุงูููุงุท</p>
  <hr>

  <h2>๐ฏ ุงููููุงุช</h2>
  <button id="earnBtn" onclick="showAd()">ุดุงูุฏ ููุฏูู ูุงุฑุจุญ 50 ููุทุฉ</button>

  <div id="adContainer">
    <script async="async" data-cfasync="false" src="//pl27503803.profitableratecpm.com/b45971d1b8aa3575bc8628fdb5505ba0/invoke.js"></script>
    <div id="container-b45971d1b8aa3575bc8628fdb5505ba0"></div>
  </div>

  <script>
    const SUPABASE_URL = "https://ulmawlwxrbtojwpviaju.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVsbWF3bHd4cmJ0b2p3cHZpYWp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTg4MDMsImV4cCI6MjA3MTY5NDgwM30.AfuqZawzxqNxJ3d7H8PTB7ywRb_YpWEvFQH9HHZvDJ8";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;
    const COOLDOWN = 30; // ุซูุงูู
    let cooldownInterval = null;

    function getOrCreateUserId() {
      let userId = localStorage.getItem("userId");
      if (!userId) {
        userId = "user_" + Date.now() + "_" + Math.floor(Math.random() * 1000);
        localStorage.setItem("userId", userId);
      }
      return userId;
    }

    async function initUser() {
      const userId = getOrCreateUserId();

      let { data: user, error } = await supabase
        .from("users")
        .select("*")
        .eq("telegram_id", userId)
        .single();

      if (error) console.log("Fetch user error:", error);

      if (!user) {
        let { data, error } = await supabase
          .from("users")
          .insert([{ telegram_id: userId, username: userId, points: 0, last_earn: null }])
          .select();

        if (error) console.log("Insert user error:", error);
        currentUser = data[0];
      } else {
        currentUser = user;
      }

      document.getElementById("points").innerText = currentUser.points;
      checkCooldown();
    }

    function startCooldown(seconds) {
      const btn = document.getElementById("earnBtn");
      btn.disabled = true;
      let remaining = seconds;

      btn.innerText = `ุงูุชุธุฑ ${remaining} ุซุงููุฉ`;

      cooldownInterval = setInterval(() => {
        remaining--;
        if (remaining <= 0) {
          clearInterval(cooldownInterval);
          btn.disabled = false;
          btn.innerText = "ุดุงูุฏ ููุฏูู ูุงุฑุจุญ 50 ููุทุฉ";
        } else {
          btn.innerText = `ุงูุชุธุฑ ${remaining} ุซุงููุฉ`;
        }
      }, 1000);
    }

    function checkCooldown() {
      if (!currentUser.last_earn) return;

      const now = new Date();
      const lastEarn = new Date(currentUser.last_earn);
      const diff = Math.floor((now - lastEarn) / 1000);

      if (diff < COOLDOWN) {
        startCooldown(COOLDOWN - diff);
      }
    }

    async function earnPoints() {
      const now = new Date();
      if (currentUser.last_earn) {
        const diff = (now - new Date(currentUser.last_earn)) / 1000;
        if (diff < COOLDOWN) {
          alert(`ุงูุชุธุฑ ${Math.ceil(COOLDOWN - diff)} ุซุงููุฉ ูุจู ุฌูุน ุงูููุงุท ูุฑุฉ ุฃุฎุฑู`);
          return;
        }
      }

      let { data, error } = await supabase
        .from("users")
        .update({ last_earn: now.toISOString() })
        .eq("telegram_id", currentUser.telegram_id)
        .increment('points', 50);

      console.log(error); // ูุงุฏู ุจุงุด ุชุนุฑู ุฃู ุฎุทุฃ ุญูููู

      if (!error && data.length > 0) {
        currentUser.points += 50;
        currentUser.last_earn = now.toISOString();
        document.getElementById("points").innerText = currentUser.points;
        alert("ุฑุจุญุช 50 ููุทุฉ!");
        startCooldown(COOLDOWN);
      } else {
        alert("ุญุฏุซ ุฎุทุฃ: " + (error ? error.message : "ุบูุฑ ูุนุฑูู"));
      }
    }

    function showAd() {
      const btn = document.getElementById("earnBtn");
      const adDiv = document.getElementById("adContainer");

      if (btn.disabled) return;

      adDiv.style.display = "block";
      btn.disabled = true;

      let countdown = 5;
      btn.innerText = `ุงูุชุธุฑ ${countdown} ุซุงููุฉ`;

      const adCountdown = setInterval(() => {
        countdown--;
        if (countdown <= 0) {
          clearInterval(adCountdown);
          adDiv.style.display = "none";
          earnPoints();
        } else {
          btn.innerText = `ุงูุชุธุฑ ${countdown} ุซุงููุฉ`;
        }
      }, 1000);
    }

    window.onload = initUser;
  </script>
</body>
</html>
