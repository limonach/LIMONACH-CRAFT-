<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù…ÙˆÙ‚Ø¹ÙŠ Ø¨Ø§Ù„Ù†Ù‚Ø§Ø·</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    #earnBtn[disabled] {
      background-color: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body style="font-family: sans-serif; direction: rtl; text-align: center;">

  <h1>Ø±ØµÙŠØ¯Ùƒ: <span id="points">0</span> Ù†Ù‚Ø·Ø©</h1>
  <hr>

  <h2>ğŸ“¢ Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
  <p>Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ ÙÙŠ Ù…ÙˆÙ‚Ø¹ ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‚Ø§Ø·</p>
  <hr>

  <h2>ğŸ¯ Ø§Ù„Ù…Ù‡Ù…Ø§Øª</h2>
  <button id="earnBtn" onclick="earnPoints()">Ø´Ø§Ù‡Ø¯ ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ø±Ø¨Ø­ 50 Ù†Ù‚Ø·Ø©</button>

  <script>
    const SUPABASE_URL = "https://ulmawlwxrbtojwpviaju.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVsbWF3bHd4cmJ0b2p3cHZpYWp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTg4MDMsImV4cCI6MjA3MTY5NDgwM30.AfuqZawzxqNxJ3d7H8PTB7ywRb_YpWEvFQH9HHZvDJ8";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;
    const COOLDOWN = 30; // Ø«ÙˆØ§Ù†ÙŠ
    let cooldownInterval = null;

    function getOrCreateUserId() {
      let userId = localStorage.getItem("userId");
      if (!userId) {
        userId = "user_" + Date.now() + "_" + Math.floor(Math.random() * 1000);
        localStorage.setItem("userId", userId);
      }
      return userId;
    }

    async function initUser() {
      const userId = getOrCreateUserId();

      let { data: user } = await supabase
        .from("users")
        .select("*")
        .eq("telegram_id", userId)
        .single();

      if (!user) {
        let { data, error } = await supabase
          .from("users")
          .insert([{ telegram_id: userId, points: 0, last_earn: null }]);
        currentUser = { telegram_id: userId, points: 0, last_earn: null };
      } else {
        currentUser = user;
      }

      document.getElementById("points").innerText = currentUser.points;

      // ØªÙØ¹ÙŠÙ„ Ø£Ùˆ ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ù†Ù‚Ø§Ø· Ø­Ø³Ø¨ cooldown
      checkCooldown();
    }

    function startCooldown(seconds) {
      const btn = document.getElementById("earnBtn");
      btn.disabled = true;
      let remaining = seconds;

      btn.innerText = `Ø§Ù†ØªØ¸Ø± ${remaining} Ø«Ø§Ù†ÙŠØ©`;

      cooldownInterval = setInterval(() => {
        remaining--;
        if (remaining <= 0) {
          clearInterval(cooldownInterval);
          btn.disabled = false;
          btn.innerText = "Ø´Ø§Ù‡Ø¯ ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ø±Ø¨Ø­ 50 Ù†Ù‚Ø·Ø©";
        } else {
          btn.innerText = `Ø§Ù†ØªØ¸Ø± ${remaining} Ø«Ø§Ù†ÙŠØ©`;
        }
      }, 1000);
    }

    function checkCooldown() {
      if (!currentUser.last_earn) return;

      const now = new Date();
      const lastEarn = new Date(currentUser.last_earn);
      const diff = Math.floor((now - lastEarn) / 1000);

      if (diff < COOLDOWN) {
        startCooldown(COOLDOWN - diff);
      }
    }

    async function earnPoints() {
      if (!currentUser) return;

      const now = new Date();
      const lastEarn = currentUser.last_earn ? new Date(currentUser.last_earn) : null;

      if (lastEarn) {
        const diff = (now - lastEarn) / 1000; // Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
        if (diff < COOLDOWN) {
          alert(`Ø§Ù†ØªØ¸Ø± ${Math.ceil(COOLDOWN - diff)} Ø«Ø§Ù†ÙŠØ© Ù‚Ø¨Ù„ Ø¬Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ø±Ø© Ø£Ø®Ø±Ù‰`);
          return;
        }
      }

      const newPoints = currentUser.points + 50;

      let { data, error } = await supabase
        .from("users")
        .update({ points: newPoints, last_earn: now.toISOString() })
        .eq("telegram_id", currentUser.telegram_id)
        .select();

      if (!error && data.length > 0) {
        currentUser.points = newPoints;
        currentUser.last_earn = now.toISOString();
        document.getElementById("points").innerText = currentUser.points;
        alert("Ø±Ø¨Ø­Øª 50 Ù†Ù‚Ø·Ø©!");

        // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ù€ cooldown
        startCooldown(COOLDOWN);
      } else {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + (error ? error.message : "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"));
      }
    }

    window.onload = initUser;
  </script>
</body>
</html>
